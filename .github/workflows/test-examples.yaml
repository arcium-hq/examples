name: Test Examples

on:
  workflow_run:
    workflows: ["Clippy Check"]
    types:
      - completed

env:
  ARCUP_USER: testnet_user_20842437
  ARCUP_TOKEN: ${{ secrets.ARCUP_TOKEN }}

jobs:
  test-examples:
    name: Test Examples
    runs-on: ${{ matrix.os }}
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      # Setup all required tools with caching
      - uses: ./.github/actions/setup/
      - uses: ./.github/actions/setup-solana/
      - uses: ./.github/actions/setup-anchor/
      - uses: ./.github/actions/setup-arcium/
        with:
          ARCUP_USER: testnet_user_20842437
          ARCUP_TOKEN: ${{ secrets.ARCUP_TOKEN }}

      # Find all example directories
      - name: Find example directories
        id: find-examples
        run: |
          echo "examples=$(find . -type f -name "Anchor.toml" -exec dirname {} \; | jq -R -s -c 'split("\n")[:-1]')" >> $GITHUB_OUTPUT
        shell: bash

      # Test each example
      - name: Test examples
        run: |
          EXAMPLES=$(echo '${{ steps.find-examples.outputs.examples }}' | jq -r '.[]')
          for example in $EXAMPLES; do
            echo "Testing $example"
            cd $example
            arcium test
            cd $GITHUB_WORKSPACE
          done
        shell: bash
